<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fluxgram | Connect Securely</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CSS VARIABLES (Theming) --- */
        :root {
            --bg-base: #0e1621; 
            --bg-surface: #17212b; 
            --bg-hover: #202b36;
            --primary: #ff0050; 
            --accent: #00f3ff; 
            --text-main: #ffffff;
            --text-muted: #7f91a4; 
            --divider: #101921; 
            --msg-rx: #182533;
            --msg-tx: #2b5278; 
            --danger: #ff3b30;
            --success: #4caf50;
            --transition: 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* Light Mode Theme overrides */
        body.light-mode {
            --bg-base: #ffffff; --bg-surface: #f0f2f5; --bg-hover: #e4e6eb;
            --text-main: #050505; --text-muted: #65676b; --divider: #cccccc;
            --msg-rx: #e4e6eb; --msg-tx: #0084ff;
        }

        /* --- RESET & MOBILE BOUNDARIES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100vw; height: 100dvh; background: var(--bg-base); color: var(--text-main); font-family: 'Roboto', sans-serif; overflow: hidden; position: fixed; inset: 0; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(127,145,164,0.3); border-radius: 4px; }
        
        button, input, textarea { font-family: inherit; outline: none; border: none; }
        .hidden { display: none !important; }

        /* --- SPA ARCHITECTURE --- */
        #app-root { display: flex; width: 100%; height: 100%; position: relative; overflow: hidden; }
        .view { position: absolute; inset: 0; background: var(--bg-base); z-index: 50; transform: translateX(100%); transition: transform var(--transition); display: flex; flex-direction: column; }
        .view.active { transform: translateX(0); }
        .base-view { position: relative; z-index: 10; transform: translateX(0); width: 100%; height: 100%; display: flex; flex-direction: column; }

        /* --- REUSABLE COMPONENTS --- */
        .header { height: 60px; background: var(--bg-surface); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid var(--divider); flex-shrink: 0; z-index: 100; }
        .icon-btn { background: transparent; color: var(--text-muted); font-size: 1.4rem; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .icon-btn:hover { background: var(--bg-hover); color: var(--accent); }
        .header-title { font-size: 1.25rem; font-weight: 500; font-family: 'Outfit', sans-serif; flex: 1; margin-left: 10px; }
        
        .avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--accent)); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; color: white; object-fit: cover; flex-shrink: 0; text-transform: uppercase; }
        .list-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid var(--divider); background: var(--bg-base); }
        .list-item:hover { background: var(--bg-hover); }
        .list-info { flex: 1; overflow: hidden; margin-left: 15px; }
        
        /* --- LOADER --- */
        .loader-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: 99999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--text-muted); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- TOAST NOTIFICATIONS --- */
        #toast-container { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: var(--bg-surface); color: var(--text-main); padding: 15px 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border-left: 4px solid var(--accent); animation: slideDown 0.3s ease forwards; font-size: 0.95rem; }
        .toast.error { border-left-color: var(--danger); }
        .toast.success { border-left-color: var(--success); }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- 1. AUTH SCREEN --- */
        #auth-view { z-index: 9000; justify-content: center; align-items: center; padding: 20px; background: radial-gradient(circle at top, #1a0b12 0%, var(--bg-base) 100%); }
        .auth-card { background: var(--bg-surface); padding: 30px; border-radius: 16px; width: 100%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--divider); }
        .auth-logo { font-size: 3rem; text-align: center; margin-bottom: 20px; font-family: 'Outfit'; }
        .auth-logo i { color: var(--primary); }
        .auth-input { width: 100%; background: var(--bg-base); padding: 15px; border-radius: 10px; color: var(--text-main); margin-bottom: 15px; font-size: 1rem; border: 1px solid var(--divider); }
        .auth-input:focus { border-color: var(--accent); }
        .auth-btn { width: 100%; padding: 15px; background: var(--primary); border-radius: 10px; color: white; font-weight: bold; cursor: pointer; font-size: 1.05rem; transition: 0.2s; }
        .auth-btn:active { transform: scale(0.97); }
        .auth-link { text-align: center; color: var(--accent); margin-top: 15px; font-size: 0.9rem; cursor: pointer; }

        /* --- 2. DASHBOARD (Chat List) --- */
        .search-bar { padding: 10px 15px; background: var(--bg-surface); border-bottom: 1px solid var(--divider); }
        .search-input-wrap { background: var(--bg-base); border-radius: 20px; display: flex; align-items: center; padding: 8px 15px; }
        .search-input-wrap input { flex: 1; background: transparent; color: var(--text-main); font-size: 0.95rem; margin-left: 10px; }
        .chat-list { flex: 1; overflow-y: auto; background: var(--bg-base); }
        .chat-name-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
        .chat-name { font-weight: 600; font-size: 1.05rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-time { font-size: 0.75rem; color: var(--text-muted); }
        .chat-msg-row { display: flex; justify-content: space-between; align-items: center; }
        .chat-msg { font-size: 0.9rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; padding-right: 10px; }
        .unread-badge { background: var(--primary); color: white; font-size: 0.75rem; font-weight: bold; padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center; }
        .fab { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--bg-base); box-shadow: 0 4px 15px rgba(0, 243, 255, 0.4); z-index: 40; cursor: pointer; transition: 0.2s; }
        .fab:active { transform: scale(0.9); }

        /* --- 3. CHAT SCREEN --- */
        .chat-bg { background: url('https://web.telegram.org/a/chat-bg-pattern-dark.png'), var(--bg-base); flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .typing-status { font-size: 0.8rem; color: var(--accent); font-weight: normal; }
        
        .messages-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg-row { display: flex; flex-direction: column; max-width: 80%; position: relative; }
        .msg-rx { align-self: flex-start; }
        .msg-tx { align-self: flex-end; }
        .msg-bubble { padding: 8px 14px; border-radius: 16px; font-size: 1rem; line-height: 1.4; word-wrap: break-word; min-width: 70px; }
        .msg-rx .msg-bubble { background: var(--msg-rx); border-bottom-left-radius: 4px; border: 1px solid var(--divider); }
        .msg-tx .msg-bubble { background: var(--msg-tx); border-bottom-right-radius: 4px; color: white; }
        .msg-media { max-width: 100%; border-radius: 8px; margin-bottom: 5px; }
        .msg-meta { font-size: 0.7rem; float: right; margin: 5px 0 0 10px; display: flex; align-items: center; gap: 4px; opacity: 0.7; }

        .input-area { background: var(--bg-surface); padding: 10px 15px; display: flex; align-items: flex-end; gap: 10px; border-top: 1px solid var(--divider); z-index: 20; }
        .input-wrapper { flex: 1; background: var(--bg-base); border-radius: 24px; padding: 10px 15px; border: 1px solid var(--divider); }
        .msg-input { width: 100%; background: transparent; color: var(--text-main); resize: none; max-height: 120px; font-size: 1rem; line-height: 1.4; }
        .msg-input::placeholder { color: var(--text-muted); }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
        .send-btn:active { transform: scale(0.9); }

        /* --- 4. CALL FEATURE (MOCK UI) --- */
        #call-overlay { position: absolute; inset: 0; background: #000; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 50px 20px; }
        .call-info { text-align: center; margin-top: 50px; }
        .call-avatar { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 20px; font-size: 4rem; display: flex; align-items: center; justify-content: center; background: var(--primary); color: white; }
        .call-name { font-size: 2rem; color: white; font-weight: 500; }
        .call-status { color: var(--accent); font-size: 1.1rem; margin-top: 10px; }
        .call-controls { display: flex; gap: 30px; margin-bottom: 30px; }
        .call-btn { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: white; cursor: pointer; }
        .btn-end { background: var(--danger); }
        .btn-accept { background: var(--success); }
        .btn-action { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); }

        /* --- 5. SIDEBAR / MENU OVERLAY --- */
        #menu-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 8000; opacity: 0; pointer-events: none; transition: 0.3s; }
        #menu-overlay.active { opacity: 1; pointer-events: all; }
        #side-drawer { position: absolute; top: 0; left: -300px; width: 280px; height: 100%; background: var(--bg-surface); z-index: 8001; transition: 0.3s; display: flex; flex-direction: column; border-right: 1px solid var(--divider); }
        #side-drawer.open { left: 0; }
        .drawer-header { padding: 30px 20px 20px; background: var(--bg-hover); border-bottom: 1px solid var(--divider); }
        .drawer-menu { flex: 1; overflow-y: auto; padding: 10px 0; }
        .drawer-item { padding: 15px 20px; display: flex; align-items: center; gap: 20px; color: var(--text-main); font-size: 1.05rem; cursor: pointer; }
        .drawer-item:hover { background: var(--bg-hover); color: var(--accent); }
        .drawer-item i { font-size: 1.3rem; color: var(--text-muted); width: 25px; text-align: center; }

    </style>
</head>
<body>

<div id="app-root">
    
    <div id="toast-container"></div>

    <div id="global-loader" class="loader-overlay hidden">
        <div class="spinner"></div>
    </div>

    <div id="auth-view" class="view active">
        <div class="auth-card">
            <div class="auth-logo"><i class="fas fa-bolt"></i> Flux<span>gram</span></div>
            
            <div id="login-form">
                <h2 style="margin-bottom: 20px; text-align: center;">Sign In</h2>
                <input type="email" id="login-email" class="auth-input" placeholder="Email Address">
                <input type="password" id="login-password" class="auth-input" placeholder="Password">
                <button class="auth-btn" onclick="appAuth.login()">Login</button>
                <div class="auth-link" onclick="appUI.toggleAuth('register')">Create an Account</div>
                <div class="auth-link" style="color:var(--text-muted);" onclick="appAuth.resetPassword()">Forgot Password?</div>
            </div>

            <div id="register-form" class="hidden">
                <h2 style="margin-bottom: 20px; text-align: center;">Sign Up</h2>
                <input type="text" id="reg-name" class="auth-input" placeholder="Full Name">
                <input type="email" id="reg-email" class="auth-input" placeholder="Email Address">
                <input type="password" id="reg-password" class="auth-input" placeholder="Password (Min 6 chars)">
                <button class="auth-btn" onclick="appAuth.register()">Sign Up</button>
                <div class="auth-link" onclick="appUI.toggleAuth('login')">Already have an account? Login</div>
            </div>
        </div>
    </div>

    <div id="dashboard-view" class="base-view">
        
        <div id="menu-overlay" onclick="appUI.toggleDrawer()"></div>
        <div id="side-drawer">
            <div class="drawer-header">
                <div class="avatar" id="drawer-avatar" style="margin-bottom: 15px;">U</div>
                <div id="drawer-name" style="font-weight: 600; font-size: 1.1rem;">User Name</div>
                <div id="drawer-email" style="font-size: 0.85rem; color: var(--text-muted); margin-top: 5px;">user@email.com</div>
            </div>
            <div class="drawer-menu">
                <div class="drawer-item" onclick="appUI.navTo('profile-view')"><i class="fas fa-user-circle"></i> My Profile</div>
                <div class="drawer-item" onclick="appUI.navTo('settings-view')"><i class="fas fa-cog"></i> Settings</div>
                <div class="drawer-item" onclick="appAuth.logout()" style="color: var(--danger);"><i class="fas fa-sign-out-alt" style="color: var(--danger);"></i> Log Out</div>
            </div>
        </div>

        <div class="header">
            <button class="icon-btn" onclick="appUI.toggleDrawer()"><i class="fas fa-bars"></i></button>
            <div class="header-title">Fluxgram</div>
            <button class="icon-btn"><i class="fas fa-search"></i></button>
        </div>
        
        <div class="search-bar">
            <div class="search-input-wrap">
                <i class="fas fa-search" style="color:var(--text-muted)"></i>
                <input type="text" id="global-search" placeholder="Search users by email..." oninput="appChat.searchUsers()">
            </div>
        </div>

        <div class="chat-list" id="chat-list">
            <div style="padding:20px; text-align:center; color:var(--text-muted);">Loading chats...</div>
        </div>

        <div class="fab" onclick="document.getElementById('global-search').focus()"><i class="fas fa-comment-dots"></i></div>
    </div>

    <div id="chat-view" class="view">
        <div class="header">
            <div style="display:flex; align-items:center; gap:10px; flex:1; overflow:hidden;" onclick="appUI.navTo('profile-view')">
                <button class="icon-btn" onclick="appUI.navBack(event)"><i class="fas fa-arrow-left"></i></button>
                <div class="avatar" id="active-chat-avatar" style="width:40px;height:40px;font-size:1rem;"></div>
                <div style="overflow:hidden;">
                    <div id="active-chat-name" style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Name</div>
                    <div id="active-chat-status" class="typing-status">last seen recently</div>
                </div>
            </div>
            <div style="display:flex;">
                <button class="icon-btn" onclick="appCall.startCall('Audio')"><i class="fas fa-phone-alt"></i></button>
                <button class="icon-btn" onclick="appCall.startCall('Video')"><i class="fas fa-video"></i></button>
                <button class="icon-btn"><i class="fas fa-ellipsis-v"></i></button>
            </div>
        </div>

        <div class="chat-bg">
            <div class="messages-container" id="messages-container">
                </div>

            <div class="input-area">
                <input type="file" id="media-upload" accept="image/*" class="hidden" onchange="appChat.uploadMedia(event)">
                <button class="icon-btn" onclick="document.getElementById('media-upload').click()"><i class="fas fa-paperclip"></i></button>
                <div class="input-wrapper">
                    <textarea id="msg-input" class="msg-input" rows="1" placeholder="Write a message..." oninput="appChat.handleTyping()"></textarea>
                </div>
                <button class="send-btn" onclick="appChat.sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="profile-view" class="view">
        <div class="header">
            <button class="icon-btn" onclick="appUI.navBack()"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Edit Profile</div>
        </div>
        <div style="padding: 20px; overflow-y: auto;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div class="avatar" id="edit-avatar" style="width:100px; height:100px; font-size:3rem; margin:0 auto 15px;">U</div>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="color:var(--accent); font-size:0.85rem; display:block; margin-bottom:5px;">Display Name</label>
                <input type="text" id="edit-name" class="auth-input" style="background:var(--bg-surface);">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="color:var(--accent); font-size:0.85rem; display:block; margin-bottom:5px;">Bio</label>
                <input type="text" id="edit-bio" class="auth-input" style="background:var(--bg-surface);" placeholder="A few words about you">
            </div>
            <button class="auth-btn" onclick="appAuth.updateProfile()">Save Changes</button>
        </div>
    </div>

    <div id="settings-view" class="view">
        <div class="header">
            <button class="icon-btn" onclick="appUI.navBack()"><i class="fas fa-arrow-left"></i></button>
            <div class="header-title">Settings</div>
        </div>
        <div style="padding: 0; overflow-y: auto;">
            <div class="list-item" onclick="appUI.toggleTheme()">
                <div class="icon-btn" style="background:var(--primary); color:white; margin-right:15px;"><i class="fas fa-moon"></i></div>
                <div class="list-info">
                    <div class="chat-name">Dark Mode</div>
                    <div class="chat-time">Toggle app theme</div>
                </div>
            </div>
            <div class="list-item" onclick="appUI.showToast('Notifications enabled.', 'success')">
                <div class="icon-btn" style="background:var(--accent); color:var(--bg-base); margin-right:15px;"><i class="fas fa-bell"></i></div>
                <div class="list-info">
                    <div class="chat-name">Notifications</div>
                    <div class="chat-time">Message alerts and sounds</div>
                </div>
            </div>
        </div>
    </div>

    <div id="call-overlay" class="hidden">
        <div class="call-info">
            <div class="call-avatar" id="call-avatar">N</div>
            <div class="call-name" id="call-name">Name</div>
            <div class="call-status" id="call-status">Calling...</div>
        </div>
        <div class="call-controls" id="call-controls-outgoing">
            <div class="call-btn btn-action" onclick="appUI.showToast('Microphone muted', '')"><i class="fas fa-microphone-slash"></i></div>
            <div class="call-btn btn-end" onclick="appCall.endCall()"><i class="fas fa-phone-slash"></i></div>
            <div class="call-btn btn-action" onclick="appUI.showToast('Speaker enabled', '')"><i class="fas fa-volume-up"></i></div>
        </div>
        <div class="call-controls hidden" id="call-controls-incoming">
            <div class="call-btn btn-end" onclick="appCall.endCall()"><i class="fas fa-phone-slash"></i></div>
            <div class="call-btn btn-accept" onclick="appCall.acceptCall()"><i class="fas fa-phone"></i></div>
        </div>
    </div>

</div>

<script type="module">
    // --- 1. FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, where, onSnapshot, addDoc, serverTimestamp, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    // --- 2. FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCsbZ1fqDivv8OyUiTcaEMcpZlJlM1TI6Y",
        authDomain: "fluxgram-87009.firebaseapp.com",
        projectId: "fluxgram-87009",
        storageBucket: "fluxgram-87009.firebasestorage.app",
        messagingSenderId: "698836385253",
        appId: "1:698836385253:web:c40e67ee9006cff536830c"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- 3. GLOBAL STATE ---
    window.AppState = {
        currentUser: null,
        userData: null,
        activeChatId: null,
        activeChatUser: null,
        unsubMessages: null,
        unsubChats: null,
        typingTimeout: null
    };

    // --- 4. UI ENGINE (Routing & UX) ---
    window.appUI = {
        viewHistory: [],
        
        toggleLoader: (show) => {
            document.getElementById('global-loader').classList.toggle('hidden', !show);
        },
        
        showToast: (msg, type = '') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = msg;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        },

        toggleAuth: (mode) => {
            document.getElementById('login-form').classList.toggle('hidden', mode === 'register');
            document.getElementById('register-form').classList.toggle('hidden', mode === 'login');
        },

        toggleDrawer: () => {
            document.getElementById('side-drawer').classList.toggle('open');
            document.getElementById('menu-overlay').classList.toggle('active');
        },

        toggleTheme: () => {
            document.body.classList.toggle('light-mode');
            appUI.showToast("Theme updated!");
        },

        navTo: (viewId) => {
            if(document.getElementById('side-drawer').classList.contains('open')) appUI.toggleDrawer();
            document.getElementById(viewId).classList.add('active');
            appUI.viewHistory.push(viewId);
        },

        navBack: (e) => {
            if(e) e.stopPropagation();
            if(appUI.viewHistory.length > 0) {
                const currentView = appUI.viewHistory.pop();
                document.getElementById(currentView).classList.remove('active');
                if(currentView === 'chat-view') {
                    AppState.activeChatId = null;
                    if(AppState.unsubMessages) AppState.unsubMessages();
                }
            }
        },

        autoResizeInput: () => {
            const el = document.getElementById('msg-input');
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }
    };
    document.getElementById('msg-input').addEventListener('input', appUI.autoResizeInput);

    // --- 5. AUTHENTICATION LOGIC ---
    window.appAuth = {
        login: async () => {
            const e = document.getElementById('login-email').value.trim();
            const p = document.getElementById('login-password').value.trim();
            if(!e || !p) return appUI.showToast("Enter email and password", "error");
            appUI.toggleLoader(true);
            try {
                await signInWithEmailAndPassword(auth, e, p);
                appUI.showToast("Welcome back!", "success");
            } catch (err) {
                appUI.showToast(err.message, "error");
            }
            appUI.toggleLoader(false);
        },

        register: async () => {
            const n = document.getElementById('reg-name').value.trim();
            const e = document.getElementById('reg-email').value.trim();
            const p = document.getElementById('reg-password').value.trim();
            if(!n || !e || p.length < 6) return appUI.showToast("Fill all fields. Password min 6 chars.", "error");
            appUI.toggleLoader(true);
            try {
                const res = await createUserWithEmailAndPassword(auth, e, p);
                await setDoc(doc(db, "users", res.user.uid), {
                    uid: res.user.uid, email: e, name: n, bio: "Available", isOnline: true, lastSeen: serverTimestamp()
                });
                appUI.showToast("Account created successfully!", "success");
            } catch (err) {
                appUI.showToast(err.message, "error");
            }
            appUI.toggleLoader(false);
        },

        logout: async () => {
            appUI.toggleDrawer();
            appUI.toggleLoader(true);
            if(AppState.currentUser) {
                await setDoc(doc(db, "users", AppState.currentUser.uid), { isOnline: false, lastSeen: serverTimestamp() }, { merge: true });
            }
            await signOut(auth);
            appUI.toggleLoader(false);
            window.location.reload(); // Hard reset SPA state
        },

        resetPassword: async () => {
            const e = document.getElementById('login-email').value.trim();
            if(!e) return appUI.showToast("Enter your email in the login field first.", "error");
            try {
                await sendPasswordResetEmail(auth, e);
                appUI.showToast("Password reset email sent!", "success");
            } catch(err) { appUI.showToast(err.message, "error"); }
        },

        updateProfile: async () => {
            const n = document.getElementById('edit-name').value.trim();
            const b = document.getElementById('edit-bio').value.trim();
            if(!n) return;
            appUI.toggleLoader(true);
            await setDoc(doc(db, "users", AppState.currentUser.uid), { name: n, bio: b }, { merge: true });
            appUI.showToast("Profile Updated", "success");
            appUI.navBack();
            appUI.toggleLoader(false);
        }
    };

    // --- 6. AUTH STATE OBSERVER ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            AppState.currentUser = user;
            // Fetch User Data
            onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                if(docSnap.exists()){
                    AppState.userData = docSnap.data();
                    // Update UI Globally
                    document.getElementById('drawer-name').innerText = AppState.userData.name;
                    document.getElementById('drawer-email').innerText = AppState.userData.email;
                    document.getElementById('drawer-avatar').innerText = AppState.userData.name.charAt(0);
                    document.getElementById('edit-name').value = AppState.userData.name;
                    document.getElementById('edit-bio').value = AppState.userData.bio;
                    document.getElementById('edit-avatar').innerText = AppState.userData.name.charAt(0);
                }
            });
            
            // Set Presence
            setDoc(doc(db, "users", user.uid), { isOnline: true }, { merge: true });
            window.addEventListener('beforeunload', () => setDoc(doc(db, "users", user.uid), { isOnline: false, lastSeen: serverTimestamp() }, { merge: true }));

            document.getElementById('auth-view').classList.remove('active');
            appChat.loadChatList();
        } else {
            document.getElementById('auth-view').classList.add('active');
        }
    });

    // --- 7. CHAT LOGIC (CRUD & Realtime) ---
    window.appChat = {
        loadChatList: () => {
            const q = query(collection(db, "chats"), where("members", "array-contains", AppState.currentUser.uid), orderBy("updatedAt", "desc"));
            AppState.unsubChats = onSnapshot(q, async (snapshot) => {
                const list = document.getElementById('chat-list');
                list.innerHTML = '';
                
                if(snapshot.empty) list.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-muted);">No chats yet. Search a user to start.</div>`;

                for (const chatDoc of snapshot.docs) {
                    const data = chatDoc.data();
                    const otherUid = data.members.find(id => id !== AppState.currentUser.uid);
                    
                    // Fetch other user info
                    const otherUserDoc = await getDoc(doc(db, "users", otherUid));
                    if(!otherUserDoc.exists()) continue;
                    const otherUser = otherUserDoc.data();

                    const timeStr = data.updatedAt ? new Date(data.updatedAt.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
                    const isTyping = data.typing && data.typing.includes(otherUid);

                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.onclick = () => appChat.openChat(chatDoc.id, otherUser);
                    
                    div.innerHTML = `
                        <div class="avatar">${otherUser.name.charAt(0)}</div>
                        <div class="list-info">
                            <div class="chat-name-row">
                                <div class="chat-name">${otherUser.name}</div>
                                <div class="chat-time">${timeStr}</div>
                            </div>
                            <div class="chat-msg-row">
                                <div class="chat-msg" style="${isTyping ? 'color:var(--accent);' : ''}">${isTyping ? 'typing...' : (data.lastMessage || 'New Chat')}</div>
                                ${data.unreadCount && data.lastSender !== AppState.currentUser.uid ? `<div class="unread-badge">${data.unreadCount}</div>` : ''}
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                }
            });
        },

        searchUsers: async () => {
            const term = document.getElementById('global-search').value.trim().toLowerCase();
            const list = document.getElementById('chat-list');
            if(term.length < 3) return appChat.loadChatList(); // Restore default list

            list.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-muted);">Searching...</div>`;
            
            // Simple query (In production, use Algolia or similar for fuzzy text search)
            const q = query(collection(db, "users"));
            const snaps = await getDocs(q);
            list.innerHTML = '';
            
            snaps.forEach(docSnap => {
                const u = docSnap.data();
                if(u.uid === AppState.currentUser.uid) return;
                if(u.email.toLowerCase().includes(term) || u.name.toLowerCase().includes(term)) {
                    list.innerHTML += `
                        <div class="list-item" onclick="appChat.startNewChat('${u.uid}')">
                            <div class="avatar">${u.name.charAt(0)}</div>
                            <div class="list-info">
                                <div class="chat-name">${u.name}</div>
                                <div class="chat-msg">${u.email}</div>
                            </div>
                        </div>
                    `;
                }
            });
            if(list.innerHTML === '') list.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-muted);">No users found.</div>`;
        },

        startNewChat: async (otherUid) => {
            document.getElementById('global-search').value = '';
            const chatId = AppState.currentUser.uid < otherUid ? `${AppState.currentUser.uid}_${otherUid}` : `${otherUid}_${AppState.currentUser.uid}`;
            
            await setDoc(doc(db, "chats", chatId), {
                members: [AppState.currentUser.uid, otherUid],
                updatedAt: serverTimestamp(),
                lastMessage: "Chat created"
            }, { merge: true });
            
            const otherUserDoc = await getDoc(doc(db, "users", otherUid));
            appChat.openChat(chatId, otherUserDoc.data());
        },

        openChat: (chatId, otherUser) => {
            AppState.activeChatId = chatId;
            AppState.activeChatUser = otherUser;
            
            document.getElementById('active-chat-name').innerText = otherUser.name;
            document.getElementById('active-chat-avatar').innerText = otherUser.name.charAt(0);
            
            // Presence Listener
            onSnapshot(doc(db, "users", otherUser.uid), (d) => {
                if(d.exists()) {
                    const statusEl = document.getElementById('active-chat-status');
                    statusEl.innerText = d.data().isOnline ? 'Online' : 'Offline';
                    statusEl.style.color = d.data().isOnline ? 'var(--accent)' : 'var(--text-muted)';
                }
            });

            appUI.navTo('chat-view');
            appChat.loadMessages();
        },

        loadMessages: () => {
            if(AppState.unsubMessages) AppState.unsubMessages();
            const container = document.getElementById('messages-container');
            
            const q = query(collection(db, `chats/${AppState.activeChatId}/messages`), orderBy("timestamp", "asc"));
            AppState.unsubMessages = onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const msg = docSnap.data();
                    const isMe = msg.senderId === AppState.currentUser.uid;
                    const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
                    
                    let content = msg.text;
                    if(msg.type === 'image') content = `<img src="${msg.mediaUrl}" class="msg-media" onclick="window.open('${msg.mediaUrl}')">`;

                    container.innerHTML += `
                        <div class="msg-row ${isMe ? 'msg-tx' : 'msg-rx'}">
                            <div class="msg-bubble">
                                ${content}
                                <div class="msg-meta">${time} ${isMe ? '<i class="fas fa-check-double" style="color:var(--accent);"></i>' : ''}</div>
                            </div>
                        </div>
                    `;
                });
                container.scrollTop = container.scrollHeight; // Auto-scroll
                
                // Reset unread count if we are viewing
                updateDoc(doc(db, "chats", AppState.activeChatId), { unreadCount: 0 });
            });
        },

        sendMessage: async () => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !AppState.activeChatId) return;

            input.value = '';
            appUI.autoResizeInput();

            await addDoc(collection(db, `chats/${AppState.activeChatId}/messages`), {
                text, senderId: AppState.currentUser.uid, timestamp: serverTimestamp(), type: 'text'
            });
            
            await setDoc(doc(db, "chats", AppState.activeChatId), { 
                lastMessage: text, 
                lastSender: AppState.currentUser.uid,
                updatedAt: serverTimestamp(),
                typing: [] // clear typing
            }, { merge: true });
        },

        uploadMedia: async (e) => {
            const file = e.target.files[0];
            if(!file || !AppState.activeChatId) return;
            
            appUI.showToast("Uploading image...", "success");
            const storageRef = ref(storage, `chats/${AppState.activeChatId}/${Date.now()}_${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);
            
            uploadTask.on('state_changed', null, (error) => appUI.showToast(error.message, "error"), async () => {
                const url = await getDownloadURL(uploadTask.snapshot.ref);
                await addDoc(collection(db, `chats/${AppState.activeChatId}/messages`), {
                    text: '', mediaUrl: url, senderId: AppState.currentUser.uid, timestamp: serverTimestamp(), type: 'image'
                });
                await setDoc(doc(db, "chats", AppState.activeChatId), { lastMessage: 'ðŸ“· Image', updatedAt: serverTimestamp() }, { merge: true });
            });
        },

        handleTyping: () => {
            if(!AppState.activeChatId) return;
            // Add self to typing array
            setDoc(doc(db, "chats", AppState.activeChatId), { typing: [AppState.currentUser.uid] }, { merge: true });
            
            clearTimeout(AppState.typingTimeout);
            AppState.typingTimeout = setTimeout(() => {
                // Remove typing status after 2 seconds
                setDoc(doc(db, "chats", AppState.activeChatId), { typing: [] }, { merge: true });
            }, 2000);
        }
    };
    // Enter to send
    document.getElementById('msg-input').addEventListener('keypress', (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); appChat.sendMessage(); }});

    // --- 8. CALL FEATURE (Mock UI Timer Engine) ---
    window.appCall = {
        timerInterval: null,
        seconds: 0,
        
        startCall: (type) => {
            if(!AppState.activeChatUser) return;
            const overlay = document.getElementById('call-overlay');
            document.getElementById('call-avatar').innerText = AppState.activeChatUser.name.charAt(0);
            document.getElementById('call-name').innerText = AppState.activeChatUser.name;
            document.getElementById('call-status').innerText = `Calling via ${type}...`;
            
            document.getElementById('call-controls-outgoing').classList.remove('hidden');
            document.getElementById('call-controls-incoming').classList.add('hidden');
            overlay.classList.remove('hidden');

            // Simulate pickup after 3 seconds
            setTimeout(() => {
                if(!overlay.classList.contains('hidden')) appCall.startTimer();
            }, 3000);
        },

        incomingCallMock: () => {
            document.getElementById('call-status').innerText = "Incoming Video Call...";
            document.getElementById('call-controls-outgoing').classList.add('hidden');
            document.getElementById('call-controls-incoming').classList.remove('hidden');
            document.getElementById('call-overlay').classList.remove('hidden');
        },

        acceptCall: () => {
            document.getElementById('call-controls-outgoing').classList.remove('hidden');
            document.getElementById('call-controls-incoming').classList.add('hidden');
            appCall.startTimer();
        },

        startTimer: () => {
            appCall.seconds = 0;
            document.getElementById('call-status').innerText = "00:00";
            appCall.timerInterval = setInterval(() => {
                appCall.seconds++;
                const mins = String(Math.floor(appCall.seconds / 60)).padStart(2, '0');
                const secs = String(appCall.seconds % 60).padStart(2, '0');
                document.getElementById('call-status').innerText = `${mins}:${secs}`;
            }, 1000);
        },

        endCall: () => {
            clearInterval(appCall.timerInterval);
            document.getElementById('call-status').innerText = "Call Ended";
            setTimeout(() => document.getElementById('call-overlay').classList.add('hidden'), 1000);
        }
    };

</script>
</body>
</html>
