<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fluxgram | Ultimate Enterprise Messenger</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Telegram Dark Theme Colors */
        :root {
            --bg-base: #0e1621; 
            --bg-surface: #17212b; 
            --bg-hover: #202b36;
            --primary: #5288c1; 
            --accent: #2b5278; 
            --text-main: #ffffff;
            --text-muted: #7f91a4; 
            --divider: #101921; 
            --msg-rx: #182533;
            --msg-tx: #2b5278; 
            --transition: 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100vw; height: 100dvh; background: var(--bg-base); color: var(--text-main); font-family: 'Roboto', sans-serif; overflow: hidden; position: fixed; inset: 0; }
        
        #app-root { display: flex; width: 100%; height: 100%; position: relative; overflow: hidden; }
        
        /* --- AUTH SCREEN (TELEGRAM STYLE) --- */
        #auth-screen { position: absolute; inset: 0; background: var(--bg-base); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; transition: 0.5s; }
        .auth-card { background: var(--bg-surface); padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .auth-logo i { font-size: 4rem; color: var(--primary); margin-bottom: 20px; }
        .auth-card h2 { margin-bottom: 10px; font-weight: 500; }
        .auth-card p { color: var(--text-muted); margin-bottom: 25px; font-size: 0.95rem; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .auth-input { width: 100%; background: transparent; border: none; border-bottom: 2px solid var(--primary); padding: 10px 5px; color: white; font-size: 1.1rem; outline: none; transition: 0.3s; }
        .auth-btn { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: 8px; color: white; font-size: 1.1rem; font-weight: 500; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .auth-btn:hover { background: #4376a3; }

        /* --- SIDEBAR & CHAT LIST --- */
        .sidebar { width: 380px; height: 100%; background: var(--bg-surface); border-right: 1px solid var(--divider); display: flex; flex-direction: column; z-index: 20; flex-shrink: 0; }
        .sb-header { padding: 10px 15px; display: flex; align-items: center; gap: 15px; }
        .search-box { flex: 1; background: var(--bg-base); border-radius: 20px; display: flex; align-items: center; padding: 0 15px; height: 42px; border: 1px solid var(--divider); }
        .search-input { background: transparent; border: none; color: white; width: 100%; outline: none; margin-left: 10px; }
        
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-cell { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; transition: 0.2s; }
        .chat-cell:hover { background: var(--bg-hover); }
        .chat-cell.active { background: var(--accent); }
        .c-avatar { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; margin-right: 15px; flex-shrink: 0; color: white; }
        
        /* --- CHAT AREA --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: url('https://web.telegram.org/a/chat-bg-pattern-dark.png') center/cover, var(--bg-base); position: relative; height: 100%; }
        .chat-top-bar { height: 60px; background: var(--bg-surface); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid var(--divider); z-index: 10; cursor: pointer; }
        .msg-scroll { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        
        .bubble-wrap { display: flex; flex-direction: column; max-width: 70%; }
        .wrap-rx { align-self: flex-start; }
        .wrap-tx { align-self: flex-end; }
        .bubble { padding: 8px 14px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; }
        .bubble-rx { background: var(--msg-rx); border-bottom-left-radius: 4px; }
        .bubble-tx { background: var(--msg-tx); border-bottom-right-radius: 4px; }
        .msg-time { font-size: 0.7rem; color: #7da570; float: right; margin: 5px 0 -5px 10px; }
        .bubble-rx .msg-time { color: var(--text-muted); }
        .chat-img { max-width: 100%; border-radius: 8px; margin-bottom: 5px; }

        .input-bar { background: var(--bg-surface); padding: 10px 20px; display: flex; align-items: flex-end; gap: 15px; }
        .msg-input-wrap { flex: 1; background: var(--bg-base); border-radius: 20px; padding: 12px 15px; display: flex; align-items: center; }
        #msgInput { width: 100%; background: transparent; border: none; color: white; outline: none; font-size: 1rem; resize: none; max-height: 100px; }
        .action-btn { background: transparent; border: none; color: var(--text-muted); font-size: 1.4rem; cursor: pointer; transition: 0.2s; padding: 5px; }
        .action-btn:hover { color: var(--primary); }
        .send-btn { color: var(--primary); }

        /* --- CALL SCREEN (Kept Your Design) --- */
        #call-view { position: absolute; inset: 0; background: linear-gradient(180deg, #1a1a2e 0%, #0a0a0c 100%); z-index: 500; display: none; flex-direction: column; align-items: center; justify-content: space-between; padding: 100px 20px; }
        .call-avatar { width: 150px; height: 150px; border-radius: 50%; border: 5px solid #00f3ff; display:flex; align-items:center; justify-content:center; font-size:4rem; background:#ff0050; color:white; box-shadow: 0 0 30px #00f3ff; animation: pulse 2s infinite; }
        .call-name { font-size: 2rem; font-weight: 700; margin-top: 20px; }
        .call-actions { display: flex; gap: 40px; margin-bottom: 50px; }
        .call-btn { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; cursor: pointer; color:white; }
        .btn-end { background: #ff3b30; }
        .btn-accept { background: #4cd964; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; }
            .chat-area { position: absolute; width: 100%; z-index: 30; transform: translateX(100%); transition: var(--transition); }
            .chat-area.active { transform: translateX(0); }
            .back-btn { display: block !important; }
        }
    </style>
</head>
<body>

    <div id="app-root">
        <div id="auth-screen">
            <div class="auth-card" id="step-phone">
                <div class="auth-logo"><i class="fas fa-paper-plane"></i></div>
                <h2>Sign in to Fluxgram</h2>
                <p>Please confirm your country code and enter your phone number.</p>
                <div class="input-group">
                    <input type="tel" class="auth-input" id="authPhone" placeholder="+880 1XXX XXXXXX" value="+880">
                </div>
                <button class="auth-btn" onclick="sendOTP()">Next</button>
                <div id="recaptcha-container" style="margin-top:15px;"></div>
            </div>

            <div class="auth-card" id="step-otp" style="display: none;">
                <div class="auth-logo"><i class="fas fa-lock"></i></div>
                <h2>Enter Code</h2>
                <p>We have sent an SMS with an activation code to your phone.</p>
                <div class="input-group">
                    <input type="text" class="auth-input" id="authOTP" placeholder="123456">
                </div>
                <button class="auth-btn" onclick="verifyOTP()">Verify</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="sb-header">
                <i class="fas fa-bars action-btn" style="font-size: 1.2rem;"></i>
                <div class="search-box">
                    <i class="fas fa-search" style="color: var(--text-muted)"></i>
                    <input type="text" class="search-input" placeholder="Search">
                </div>
            </div>
            <div class="chat-list" id="chatList">
                </div>
        </div>

        <div class="chat-area" id="chatArea">
            <div class="chat-top-bar">
                <div style="display:flex; align-items:center; gap:15px;">
                    <i class="fas fa-arrow-left action-btn back-btn" onclick="closeChat()" style="display:none; font-size: 1.2rem;"></i>
                    <div class="c-avatar" style="width:40px; height:40px; font-size:1rem; background:#ff0050">K</div>
                    <div>
                        <div style="font-weight:500; font-size: 1.1rem;">KAWCHUR (CEO)</div>
                        <div style="font-size:0.85rem; color:var(--primary);">last seen recently</div>
                    </div>
                </div>
                <div style="display:flex; gap:20px;">
                    <i class="fas fa-phone-alt action-btn" onclick="startCall()"></i>
                    <i class="fas fa-search action-btn"></i>
                    <i class="fas fa-ellipsis-v action-btn"></i>
                </div>
            </div>
            
            <div class="msg-scroll" id="msgScroll"></div>
            
            <div class="input-bar">
                <input type="file" id="fileInput" style="display:none;" accept="image/*" onchange="uploadFile(event)">
                <button class="action-btn" onclick="document.getElementById('fileInput').click()"><i class="fas fa-paperclip"></i></button>
                
                <div class="msg-input-wrap">
                    <textarea id="msgInput" rows="1" placeholder="Write a message..."></textarea>
                    <button class="action-btn"><i class="far fa-smile"></i></button>
                </div>
                <button class="action-btn send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="call-view">
            <div class="call-avatar">K</div>
            <h1 class="call-name">KAWCHUR (CEO)</h1>
            <p style="color:var(--primary); letter-spacing:2px; margin-top:10px;">Flux Secure Call...</p>
            <div class="call-actions">
                <div class="call-btn btn-end" onclick="endCall()"><i class="fas fa-phone-slash"></i></div>
                <div class="call-btn btn-accept" onclick="alert('Call Connected!')"><i class="fas fa-phone"></i></div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCsbZ1fqDivv8OyUiTcaEMcpZlJlM1TI6Y",
            authDomain: "fluxgram-87009.firebaseapp.com",
            projectId: "fluxgram-87009",
            storageBucket: "fluxgram-87009.firebasestorage.app",
            messagingSenderId: "698836385253",
            appId: "1:698836385253:web:c40e67ee9006cff536830c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let activeChatId = "global_chat"; // Using a global chat for demo

        // --- AUTHENTICATION (Telegram Style Phone Auth) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                initChatApp();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
            }
        });

        window.sendOTP = () => {
            const phone = document.getElementById('authPhone').value;
            if(!phone) return alert("Enter valid phone number!");
            
            window.recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' }, auth);
            
            signInWithPhoneNumber(auth, phone, window.recaptchaVerifier)
                .then((confirmationResult) => {
                    window.confirmationResult = confirmationResult;
                    document.getElementById('step-phone').style.display = 'none';
                    document.getElementById('step-otp').style.display = 'block';
                }).catch((error) => {
                    console.error("SMS not sent", error);
                    alert("Error sending SMS. Ensure Phone Auth is enabled in Firebase Console.");
                });
        };

        window.verifyOTP = () => {
            const code = document.getElementById('authOTP').value;
            confirmationResult.confirm(code).then((result) => {
                currentUser = result.user;
                document.getElementById('auth-screen').style.display = 'none';
                initChatApp();
            }).catch((error) => {
                alert("Invalid OTP!");
            });
        };

        // --- CHAT SYSTEM (Firestore) ---
        function initChatApp() {
            // Load Chat List
            document.getElementById('chatList').innerHTML = `
                <div class="chat-cell active">
                    <div class="c-avatar" style="background:#ff0050">K</div>
                    <div style="flex:1">
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-weight:500">KAWCHUR (CEO)</span>
                            <span style="font-size:0.75rem; color:var(--text-muted)">Just now</span>
                        </div>
                        <div style="font-size:0.9rem; color:var(--text-muted)">Welcome to Fluxgram!</div>
                    </div>
                </div>
            `;
            loadMessages();
        }

        function loadMessages() {
            const scroll = document.getElementById('msgScroll');
            const q = query(collection(db, "chats", activeChatId, "messages"), orderBy("timestamp", "asc"));
            
            onSnapshot(q, (snapshot) => {
                scroll.innerHTML = '';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const isMe = d.senderId === currentUser.uid;
                    const time = d.timestamp ? new Date(d.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
                    
                    // Check if it's an image or text
                    let contentHTML = d.imageUrl 
                        ? `<img src="${d.imageUrl}" class="chat-img"><br>${d.text || ''}` 
                        : d.text;

                    scroll.innerHTML += `
                        <div class="bubble-wrap ${isMe ? 'wrap-tx' : 'wrap-rx'}">
                            <div class="bubble ${isMe ? 'bubble-tx' : 'bubble-rx'}">
                                ${contentHTML}
                                <span class="msg-time">${time} ${isMe ? '<i class="fas fa-check-double"></i>' : ''}</span>
                            </div>
                        </div>
                    `;
                });
                scroll.scrollTop = scroll.scrollHeight;
            });
        }

        window.sendMessage = async (imageUrl = null) => {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if(!text && !imageUrl) return;
            
            await addDoc(collection(db, "chats", activeChatId, "messages"), {
                text: text,
                imageUrl: imageUrl,
                senderId: currentUser.uid,
                timestamp: serverTimestamp()
            });
            input.value = '';
        };

        // --- FIREBASE STORAGE (Image Upload) ---
        window.uploadFile = (event) => {
            const file = event.target.files[0];
            if(!file) return;

            const storageRef = ref(storage, 'chat_images/' + Date.now() + '_' + file.name);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed', 
                (snapshot) => { /* Could add progress bar here */ }, 
                (error) => { alert("Upload failed!"); console.error(error); }, 
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                        sendMessage(downloadURL); // Send image URL as message
                    });
                }
            );
        };

        // --- UI UTILS & CALL SYSTEM ---
        window.closeChat = () => document.getElementById('chatArea').classList.remove('active');
        
        window.startCall = () => document.getElementById('call-view').style.display = 'flex';
        window.endCall = () => document.getElementById('call-view').style.display = 'none';

        // Submit message on Enter key
        document.getElementById('msgInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
